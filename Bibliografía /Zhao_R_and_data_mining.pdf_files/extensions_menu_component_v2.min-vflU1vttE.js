define(["require","exports","tslib","classnames","react-redux","react","spectrum/button","spectrum/popover","spectrum/tertiary_link","modules/clean/file_store/utils","modules/clean/integrations/data/selectors","modules/clean/react/app_actions/apis","modules/clean/react/app_actions/shared_file_popover_content_component","modules/clean/react/app_actions/telemetry_client","modules/clean/react/css","modules/clean/react/extensions/data/action_creators","modules/clean/react/extensions/data/helpers","modules/clean/react/extensions/data/selectors","modules/clean/react/extensions/data/types","modules/clean/react/extensions/extensions_popover_content_component_v2","modules/clean/react/extensions/extensions_utils","modules/clean/react/extensions/file","modules/clean/react/extensions/tooltips","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/logging","modules/clean/react/file_viewer/open_button/types","modules/clean/react/file_viewer/unity/with_unity","modules/clean/react/file_viewer_sidebar/buttons/icon","modules/clean/react/files_view/constants","modules/clean/react/portal_popover","modules/core/i18n","spectrum/tooltip","modules/constants/file_viewer"],(function(e,t,n,o,r,i,a,s,l,p,c,u,d,g,f,m,_,h,v,T,y,C,w,E,P,S,O,A,x,B,b,N,I){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),o=n.__importDefault(o),i=n.__importDefault(i);var D="TOOLTIP_ONLY"===I.FILES_2_COLLAPSED_SHARE_COPY_TOOLTIP_CHANGES,M="COPY_AND_TOOLTIP"===I.FILES_2_COLLAPSED_SHARE_COPY_TOOLTIP_CHANGES,F=(function(e){function t(t){var o=e.call(this,t)||this;return o.setActionMenuRef=function(e){o.actionMenuContent=e},o.openOptionsArgs=function(){var e=o.props,t=e.featureFlags,r=e.telemetryContext,i=r?r.surface:void 0,a="ON"===t.cloudEditorsEnabled;return n.__assign(n.__assign({},o.props),{isCloudEditorDisabled:a,surface:i})},o.handleButtonClick=function(e){e.preventDefault(),e.stopPropagation(),o.setPopoverContentPosition()},o.handleHover=function(){o.currentSession&&o.currentSession.event("trigger_hover")},o.setBigTooltip=function(e){return n.__awaiter(o,void 0,void 0,(function(){var t,o,r,i,a,s,l,p,c;return n.__generator(this,(function(n){switch(n.label){case 0:return t=this.props,o=t.file,r=t.appActions,i=t.featureFlags,a=C.getFileExt(o)||"",(s=r.length>0)?[4,u.getTooltipHistory(e,["open_with_edu"])]:[3,2];case 1:l=n.sent(),p=w.allowedTooltips(s,a,i),c=p.find((function(e){return void 0!==l[e]&&!l[e]})),this.setState({bigTooltipName:c}),n.label=2;case 2:return[2]}}))}))},o.markBigTooltipViewed=function(){var e=!1,t=[];o.state.bigTooltipName&&(t.push(u.markTooltipViewed(o.props.user.id,o.state.bigTooltipName)),e=!0),e&&(Promise.all(t).then((function(){o.props.showBigTooltip&&o.setBigTooltip(o.props.user.id)})),o.setState({bigTooltipName:void 0}))},o.handleSelectAction=function(e,t){t.preventDefault(),e.handler(),o.props.onExtensionClick&&o.props.onExtensionClick(e.actionName||e.userAction),o.logToPreviews(e,!1),t.stopPropagation()},o.logToPreviews=function(e,t){if(o.props.telemetryContext&&"previews"===o.props.telemetryContext.surface&&e.userAction){var n=t?E.UserActionContext.TitleBarMain:E.UserActionContext.TitleBarSplitButton,r=e.actionName?{app_action_name:e.actionName}:{};p.isBrowseFile(o.props.file)&&o.props.file.read_only&&(r.readOnly=!0),P.logUserAction(e.userAction,n,r)}},o.renderTrigger=function(){var e=o.props.triggerType===v.TriggerType.SidebarLink?i.default.createElement(l.TertiaryLink,{className:"app-action-open-with-menu__trigger app-action-open-with-menu__trigger-link",icon:"open-with"},o.triggerText()):i.default.createElement(a.Button,{className:"app-action-open-with-menu__trigger app-action-open-with-menu__trigger-button",variant:o.props.triggerType===v.TriggerType.SecondaryButton||o.props.triggerType===v.TriggerType.CollapsedButton?"secondary":"primary",tagName:"span"},o.renderTriggerButtonContent());return i.default.createElement("div",{onMouseDown:o.markBigTooltipViewed,onMouseEnter:o.handleHover},e)},o.renderExtensionPopoverV2Content=function(e){return function(){var t=o.props,n=t.file,r=t.user,a=t.appActions,s=t.bylines,l=t.categoryInfos,c=t.featureFlags,u=t.telemetryContext,g=y.getCategoryIdToInfos(l);if(p.isBrowseFile(n)&&(a.length>0||e.length>0))return i.default.createElement(T.ExtensionsPopoverV2WithUnity,{file:n,user:r,openOptions:e,appActions:a,bylines:s,categoryIdToInfos:g,featureFlags:c,updateLinkState:o.handleUpdateLinkState,telemetryContext:u,currentSession:o.currentSession});if(p.isSharedFile(n)){var f=_.partitionActions(a).cloudEditors;return i.default.createElement(d.SharedFilePopoverContent,{openOptions:e,cloudEditorAppActions:f,file:n,user:r,currentSession:o.currentSession})}return null}},o.renderMenu=function(e){var t=o.props,n=t.scrollableSidebarRef;return t.shouldUsePortalPopover?i.default.createElement("div",{className:"app-action-open-with-menu",ref:o.setActionMenuRef},i.default.createElement(B.PortalPopover,{className:"app-action-open-with-menu__popover",popoverTriggerSelector:".app-action-open-with-menu__trigger",renderPopoverTrigger:o.renderTrigger,renderPopoverItems:o.renderExtensionPopoverV2Content(e),scrollableContainer:n,onSelection:o.handleSelectAction,onMenuToggle:o.onPopoverToggle})):i.default.createElement("div",{className:"app-action-open-with-menu",ref:o.setActionMenuRef},i.default.createElement(s.Popover,{className:"app-action-open-with-menu__popover",onClick:o.handleButtonClick,onDoubleClick:o.handleButtonClick,onSelection:o.handleSelectAction,onMenuToggle:o.onPopoverToggle,closeOnSelection:!0},i.default.createElement(s.PopoverTrigger,null,o.renderTrigger()),i.default.createElement(s.PopoverContent,{position:o.state.popoverContentPosition,attachment:"right",height:o.state.height},o.renderExtensionPopoverV2Content(e)())))},o.onPopoverToggle=function(e){var t=e.isOpen;t&&o.props.onDropdownOpen?o.props.onDropdownOpen():!t&&o.props.onDropdownClose&&o.props.onDropdownClose(),o.currentSession&&o.currentSession.event(t?"open_popover":"close_popover")},o.onDownloadClick=function(e){return function(t){t.preventDefault(),t.stopPropagation(),e.handler(),o.logToPreviews(e,!0)}},o.handleUpdateLinkState=function(e,t){var n=o.props.updateLinkState;n&&n({actionId:e,linkState:t})},o.state={popoverContentPosition:"below"},o.telemetryClient=g.createTelemetryClient({component:"menu_v2"}),o}return n.__extends(t,e),t.prototype.componentDidMount=function(){this.props.showBigTooltip&&this.setBigTooltip(this.props.user.id)},t.prototype.setPopoverContentPosition=function(){var e=this.actionMenuContent.getElementsByClassName("app-action-open-with-menu__trigger")[0],t=2*x.OverflowMenuConstants.MENU_MARGIN_PX,n=0,o=this.props,r=o.appActions,i=o.telemetryContext;y.getOpenOptionsForFile(this.openOptionsArgs()).forEach((function(e){e.type===S.OpenButtonAction.OPEN_IN_PAPER?n+=40:e.type===S.OpenButtonAction.OPEN_WITH||e.type===S.OpenButtonAction.OPEN_WITH_CLOUD_DOC?n+=40:e.type!==S.OpenButtonAction.UNITY_FILE&&e.type!==S.OpenButtonAction.UNITY_FOLDER||(n+=40)})),n+=n?t+19:0;var a=_.partitionActions(r),s=a.cloudEditors,l=a.installedActions,p=a.promotedActions;l.concat(p.slice(0,5)).forEach((function(e){n+=52})),s.forEach((function(e){n+=52})),n+=l.length>0?t+19:0,n+=p.length>0?22+t:0,n+=p.length>5?40:0;var c=e.getBoundingClientRect();if(c.top>n+132&&c.bottom+n+60>window.innerHeight)this.setState({popoverContentPosition:"above"});else if(this.setState({popoverContentPosition:"below"}),i&&["sidebar","previews"].includes(i.surface)){var u=Math.min(n,window.innerHeight-c.bottom-60);this.setState({height:u})}},t.prototype.triggerText=function(){return b.intl.formatMessage({defaultMessage:"Open"})},t.prototype.renderTriggerButtonContent=function(){var e=this.triggerText();if(this.props.triggerType===v.TriggerType.CollapsedButton){var t=i.default.createElement("div",{className:"app-actions-open-with-menu__trigger-content"},i.default.createElement(A.ButtonIcon,{name:"open","aria-label":e}));return(D||M)&&this.props.triggerType===v.TriggerType.CollapsedButton?i.default.createElement(N.Tooltip,{positionOffset:8,positioning:"left",tooltipContent:b.intl.formatMessage({defaultMessage:"Open With"})},t):t}return i.default.createElement("div",{className:"app-actions-open-with-menu__trigger-content app-actions-open-with-menu__trigger-content--with-text"},i.default.createElement("div",{className:"app-action-open-with-menu__trigger-button-text"},e+" â–¾"))},t.prototype.render=function(){var e=this.props,t=e.file,n=e.appActions,r=e.featureFlags,s=e.isInFVSidebar,l=e.telemetryContext,c=e.triggerType,u=e.showAsButtonIfDownloadOnly;if(!t.file_id)return null;l?this.currentSession=this.telemetryClient.session({surface:l.surface,ext:g.getPiiSafeExtension(C.getFileExt(t)||""),feature_flags:r}):delete this.currentSession;var d=y.getOpenOptionsForFile(this.openOptionsArgs()),f=c===v.TriggerType.CollapsedButton,m=d.length>0,h=!1;if(m&&1===d.length&&(m=!(h=d[0].type===S.OpenButtonAction.DOWNLOAD)),!m&&(0===n.length||p.isSharedFile(t)&&0===_.partitionActions(n).cloudEditors.length)){if(u&&h){var T=c===v.TriggerType.SecondaryButton||f?"secondary":"primary",w=f||s&&"secondary"===T;return i.default.createElement(a.Button,{className:o.default("app-actions-download-button",{"app-actions-download-button--collapsed":w}),variant:T,onClick:this.onDownloadClick(d[0])},w?i.default.createElement(A.ButtonIcon,{name:"download-file",isPrimary:"primary"===T,"aria-label":b.intl.formatMessage({defaultMessage:"Download"})}):b.intl.formatMessage({defaultMessage:"Download"}))}return null}return this.renderMenu(d)},t.defaultProps={showAsButtonIfDownloadOnly:!1,triggerType:v.TriggerType.SecondaryButton},t})(i.default.Component);t.ExtensionsMenuV2Component=F;var k=function(e,t){return{appActions:h.getOpenActionsForFile(e,t.file),bylines:h.getBylines(e),categoryInfos:h.getCategoryInfos(e),featureFlags:h.getFeatureFlags(e),cloudDocsInfo:h.getCloudDocInfo(e),landingPagesEnabled:c.isConnectServiceLandingPagesEnabled(e)}},L={updateLinkState:m.updateLinkState,refreshSharingServiceInfo:m.refreshSharingServiceInfoAdapter},U=r.connect(k,L)(F);t.ExtensionsMenuV2NoUnity=f.requireCssWithComponent(U,["/static/css/app_actions/index-vfle4rJAa.css"]);var H=r.connect(k,L)((function(e){return p.isBrowseFile(e.file)?i.default.createElement(O.WithUnity,{file:e.file,user:e.user,render:function(t){return i.default.createElement(F,n.__assign({},e,{unityInfo:t}))}}):i.default.createElement(F,n.__assign({},e))}));t.ExtensionsMenuV2=f.requireCssWithComponent(H,["/static/css/app_actions/index-vfle4rJAa.css"])}));
//# sourceMappingURL=extensions_menu_component_v2.min.js-vflEif0KK.map